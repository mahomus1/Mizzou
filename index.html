<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fellow Schedule</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f6;
        }
        .table-wrapper { 
            width: 100%;
            overflow: auto; 
        }
        .table-container {
            max-height: 70vh;
            overflow: auto; 
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform-origin: top left; 
            transition: transform 0.2s ease-out, width 0.2s ease-out, max-height 0.2s ease-out; 
        }
        table {
            width: 100%;
            min-width: 1000px; 
            border-collapse: collapse;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem; 
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            transition: padding 0.2s ease-out, font-size 0.2s ease-out; 
        }
        tbody td:not(:first-child), thead th:not(:first-child) {
            white-space: nowrap;
        }

        @media (min-width: 640px) { 
            th, td {
                padding: 0.75rem 1rem;
                font-size: 1rem;
            }
        }

        th {
            background-color: #607d8b; 
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:nth-child(even) { background-color: #eceff1; }
        tr:nth-child(odd) { background-color: #ffffff; }
        tr:hover { background-color: #cfd8dc; }

        thead th:first-child {
            position: sticky;
            left: 0;
            z-index: 12; 
            background-color: #607d8b; 
            white-space: normal; 
        }
        tbody td:first-child {
            position: sticky;
            left: 0;
            z-index: 5; 
            white-space: normal; 
            min-width: 80px; 
            vertical-align: top; 
            background-color: white; 
            transition: padding 0.2s ease-out, font-size 0.2s ease-out, min-width 0.2s ease-out;
        }
        tr:nth-child(odd) td:first-child { background-color: #ffffff; } 
        tr:nth-child(even) td:first-child { background-color: #eceff1; } 
        tr:hover td:first-child { background-color: #cfd8dc; } 

        .controls-wrapper { 
             margin-bottom: 1.5rem;
        }
        .controls {
            background-color: #ffffff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        @media (min-width: 640px) { 
            .controls { padding: 1.5rem; }
        }
        select {
            padding: 0.5rem 0.75rem; font-size: 0.875rem;
            border-radius: 0.375rem; border: 1px solid #d1d5db; 
            background-color: white; margin-top: 0.25rem;
        }
        @media (min-width: 640px) { 
            select { font-size: 1rem; }
        }
        .no-assignment { color: #9ca3af; font-style: italic; }

        .fellow-buttons-details, .legend-details { 
            margin-top: 1rem;
        }
        .fellow-buttons-details summary, .legend-details summary {
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            background-color: #f3f4f6; 
            border: 1px solid #e5e7eb; 
            border-radius: 0.375rem; 
            list-style-position: inside; 
            outline: none; 
        }
        .fellow-buttons-details[open] summary, .legend-details[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
            border-bottom: none; 
        }
        .fellow-buttons-container, .legend-details div { 
            padding: 0.75rem; 
            border: 1px solid #e5e7eb; 
            border-top: none;
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }
        .fellow-buttons-container {
            display: flex; flex-wrap: wrap;
            gap: 0.5rem; align-items: center;
        }


        .fellow-btn, .action-btn { 
            background-color: #90a4ae; color: white; padding: 0.5rem 0.75rem;
            border: none; border-radius: 0.375rem; cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s, padding 0.2s, font-size 0.2s; 
            font-size: 0.875rem;
        }
        .fellow-btn:hover, .action-btn:hover { background-color: #78909c; }
        .fellow-btn.active {
            background-color: #546e7a; 
            box-shadow: 0 0 0 2px #ffffff, 0 0 0 4px #546e7a; 
        }
        .clear-highlights-btn {
            background-color: #ef5350; color: white; padding: 0.5rem 1rem;
            border: none; border-radius: 0.375rem; cursor: pointer;
            transition: background-color 0.2s; font-size: 0.875rem;
        }
        .clear-highlights-btn:hover { background-color: #e53935; }
        
        #export-ics-btn {
            background-color: #4CAF50; 
            margin-left: 1rem;
        }
        #export-ics-btn:hover {
             background-color: #388E3C;
        }

        .highlight-cell-base { font-weight: bold; position: relative; }
        .highlight-zt { background-color: #fff59d !important; } 
        .highlight-mm { background-color: #a5d6a7 !important; } 
        .highlight-xd { background-color: #b39ddb !important; } 
        .highlight-df { background-color: #81d4fa !important; } 
        .highlight-mg { background-color: #ffab91 !important; } 
        .highlight-im { background-color: #ce93d8 !important; } 
        .highlight-aa { background-color: #f48fb1 !important; } 
        .highlight-ez { background-color: #9fa8da !important; } 
        .highlight-am { background-color: #ffe082 !important; } 
        .highlight-md { background-color: #ef9a9a !important; } 
        
        .current-week-highlight td { background-color: #c8e6c9 !important; }
        .current-week-highlight td:first-child { background-color: #c8e6c9 !important; }
        
        .toggle-switch-label {
            margin-top: 1rem; display: flex; align-items: center;
            cursor: pointer; font-size: 0.875rem; color: #374151; 
            transition: font-size 0.2s;
        }
        .toggle-switch-label input[type="checkbox"] { opacity: 0; width: 0; height: 0; }
        .toggle-switch-slider {
            width: 34px; height: 20px; background-color: #d1d5db; 
            border-radius: 9999px; position: relative;
            transition: background-color 0.2s; margin-right: 0.5rem; 
        }
        .toggle-switch-slider::before {
            content: ""; position: absolute; height: 16px; width: 16px;
            left: 2px; bottom: 2px; background-color: white;
            border-radius: 50%; transition: transform 0.2s;
        }
        input:checked + .toggle-switch-slider { background-color: #607d8b; }
        input:checked + .toggle-switch-slider::before { transform: translateX(14px); }

        .call-icon-inline { margin-left: 0.25rem; font-size: 0.75em; }
        .asterisk-note {
            color: #000000; /* Changed to black */
            font-size: 0.8em; 
            font-style: italic;
            white-space: normal; 
            margin-left: 2px; /* Keep a small space from the initials */
            display: inline; /* Allow it to be on the same line if space permits, but wrap if needed */
        }
        
        .holiday-indicator {
            display: flex; 
            align-items: flex-start; 
            margin-bottom: 1px; 
            font-size: 0.9em; 
            white-space: normal; 
            line-height: 1.1;
        }
        .holiday-indicator .emoji { 
            font-size: 1em; 
            margin-right: 2px; 
            flex-shrink: 0; 
        }
        .holiday-indicator .date-text { 
            font-size: 0.85em; /* Adjusted for black text */
            color: #000000; /* Black text */
            white-space: normal; 
            word-break: break-word; 
        }
        .week-cell-content { 
            display: block; 
            white-space: normal; 
            word-break: break-all; 
        }
        .holiday-indicators-container {
            display: block; 
            margin-top: 1px; 
            line-height: 1.1;
        }
        
        .zoom-slider-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.875rem;
            color: #374151;
        }
        .zoom-slider-container input[type="range"] {
            width: 120px; 
            cursor: pointer;
        }
        #call-legend-content {
            font-size: 0.8rem;
            color: #4b5563; 
        }
        #call-legend-content p {
            margin-bottom: 0.25rem;
        }
         #call-legend-content .legend-item {
            margin-bottom: 0.3rem;
        }
        #call-legend-content .legend-symbol {
            display: inline-block;
            width: 20px; 
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body class="p-2 sm:p-4 md:p-8"> 
    <div class="container mx-auto">
        <h1 class="text-2xl sm:text-3xl font-bold mb-4 sm:mb-6 text-center text-gray-700">Fellows Schedule</h1>

        <div class="controls-wrapper"> 
            <div class="controls">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                    <div>
                        <label id="fellow-select-label" for="fellow-select" class="block text-base sm:text-lg font-medium text-gray-700 mb-1 sm:mb-2">Select Fellow</label>
                        <div class="flex items-center">
                            <select id="fellow-select" class="w-full sm:w-auto p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="all">Show All Schedules</option>
                            </select>
                            <button id="export-ics-btn" class="action-btn hidden" title="Export to iCalendar (.ics)">üóìÔ∏è Export ICS</button>
                        </div>
                    </div>
                    <div class="flex flex-col items-start sm:items-end mt-4 sm:mt-0">
                        <label id="hide-previous-weeks-label" class="toggle-switch-label"> 
                            <input type="checkbox" id="hide-previous-weeks-toggle" checked> 
                            <span class="toggle-switch-slider"></span>
                            Hide Previous Weeks
                        </label>
                        <div id="zoom-slider-container" class="zoom-slider-container mt-2">
                            <label for="zoom-slider">Zoom Table:</label> 
                            <input type="range" id="zoom-slider" min="0.3" max="1.0" value="1" step="0.05"> 
                            <span id="zoom-value">100%</span> 
                        </div>
                    </div>
                </div>
                <details class="fellow-buttons-details" id="fellow-buttons-details">
                    <summary>Highlight Fellows</summary>
                    <div id="fellow-buttons-container" class="fellow-buttons-container">
                        </div>
                </details>
                </div>
        </div>


        <div class="table-wrapper"> 
            <div id="schedule-display" class="table-container">
                </div>
        </div>
        <div id="no-data-message" class="hidden text-center text-gray-500 mt-6 sm:mt-8 text-lg sm:text-xl">
            No schedule data found for the selected fellow.
        </div>
        
        <details class="legend-details" id="call-legend-details">
            <summary>Legend</summary>
            <div id="call-legend-content">
                <p><span class="legend-symbol">üìû</span> = On Call</p>
                <p class="mt-1"><em>Note: Call starts Friday 4:30 PM of the preceding week and ends Friday morning of the listed week.</em></p>
                <p><span class="legend-symbol">*</span>&nbsp;&nbsp;&nbsp;= Thanksgiving call (AA)</p>
                <p><span class="legend-symbol">**</span> = Last weekend call (MD)</p>
            </div>
        </details>
    </div>

    <script>
        const mainScheduleCsvData = `Week,UMH 1,UMH2,VA1,VA 2,VA 3,VA 4,Amb1,EOD1,EOD2,Research,Elective,Vacations
6/30-7/4,MG,ZT,DF,XD,,,IM,MM,,,,
7/7- 7/11,ZT,MG,IM,MM,,,DF,XD,,,,
7/14-7/18,IM,DF,MG,EZ,AM,MM,AA,XD,ZT,MD,,
7/21-7/25,DF,IM,MG,ZT,EZ,MD,AM,MM,XD,,,AA
7/28-8/1,ZT,MG,AA,MD,XD,DF,EZ,MM,,AM,,IM
8/4-8/8,MG,ZT,AM,DF,MM,AA,MD,XD,,EZ,,IM
8/11- 8/15,DF,XD,MD,MG,IM,AA,EZ,ZT,MM,,,AM
8/18-8/22,XD,DF,EZ,IM,MG,AA,AM,ZT,,MD,MM,
8/25-8/29,MM,AM,MD,DF,MG,IM,EZ,ZT,,AA,,XD
9/1-9/5,AM,MM,IM,MG,DF,,MD,XD,ZT,EZ,,AA
9/8-9/12,IM,AA,XD,MD,DF,AM,EZ,ZT,MM,,,MG
9/15-9/19,AA,IM,MD,MG,DF,EZ,AM,XD,ZT,MM,,
9/22-9/26,MG,MD,DF,EZ,IM,ZT,AA,XD,,AM,MM,
9/29-10/3,MD,MG,AM,XD,AA,IM,DF,MM,,EZ,ZT,
10/6-10/10,EZ,DF,AM,MG,IM,,AA,XD,ZT,MD,,MM
10/13-10/17,DF,EZ,AA,AM,IM,MG,MD,ZT,XD,MM,,
10/20-10/24,AA,AM,MD,XD,MG,DF,EZ,ZT,MM,IM,,
10/27-10/31,AM,AA,EZ,IM,MG,XD,MD,MM,,DF,,ZT
11/3-11/7,IM,MD,DF,AM,ZT,,MG,MM,,AA,XD,EZ
11/10-11/14,MD,IM,MG,EZ,DF,,AM,ZT,XD,MM,,AA
11/17-11/21,EZ,MD,MG,AA,DF,,IM,ZT,XD,AM,,MM
11/24-11/28,MD,EZ,IM,DF,MG,,AA,MM,ZT,XD,,AM
12/1-12/5,AA,AM,XD,EZ,MG,,DF,ZT,,IM,MM,MD
12/8-12/12,AM,AA,IM,DF,EZ,,MG,XD,MM,,ZT,MD
12/15-12/19,DF,EZ,IM,AA,MG,,AM,MM,XD,MD,,ZT
12/22-12-26,EZ,DF,MM,AA,MG,MD,IM,XD,,,AM,ZT
12/29-1/2/26,MG,MD,IM,XD,EZ,AM,AA,MM,,ZT,,DF
01/05-01/09,MD,MG,AA,AM,IM,MM,EZ,ZT,,DF,,XD
01/12-01/16,AA,AM,MD,IM,DF,EZ,MG,MM,ZT,,,XD
01/19-01/23,AM,AA,EZ,MM,MD,DF,IM,ZT,,XD,,MG
01/26-01/30,MM,EZ,IM,AA,DF,,MD,ZT,,AM,XD,MG
02/02-02/06,EZ,MM,ZT,DF,AM,MD,AA,XD,,MG,,IM
02/09-02/13,XD,MD,MG,EZ,DF,,AM,ZT,MM,AA,,IM
02/16-02/20,MD,XD,DF,AM,MG,,AA,MM,,IM,ZT,EZ
02/23-02/27,AA,IM,AM,ZT,MD,MM,DF,XD,,MG,,EZ
03/02-03/06,IM,AA,AM,DF,MG,,MD,ZT,MM,EZ,XD,
03/09-03/13,EZ,AM,AA,MD,IM,,MG,MM,ZT,DF,XD,
03/16-03/20,AM,EZ,AA,MG,DF,,MD,XD,MM,IM,ZT,
03/23-03/27,MG,MD,EZ,DF,IM,,AM,MM,XD,ZT,,AA
03/30-04/03,MD,MG,ZT,AA,IM,AM,EZ,MM,,XD,,DF
04/06-04/10,AA,AM,EZ,IM,MG,,MD,XD,ZT,,MM,DF
04/13-04/17,AM,AA,MG,MD,EZ,IM,DF,ZT,XD,,,MM
04/20-04/24,DF,EZ,AA,MD,MG,IM,AM,ZT,XD,,,MM
04/27-05/01,EZ,DF,AA,AM,ZT,,IM,XD,MG,MM,,MD
05/04-05/08,AM,IM,EZ,MM,ZT,,AA,XD,DF,MG,,MD
5/11-5/15,IM,AM,MD,ZT,DF,,EZ,MM,XD,AA,,MG
05/18-05/22,MD,MG,MM,EZ,AA,,IM,XD,ZT,DF,,AM
05/25-05/29,MG,MD,AM,,XD,AA,EZ,MM,IM,ZT,,DF
06/01-06/05,DF,AA,AM,MD,IM,,MG,ZT,MM,XD,,EZ
06/08-06/12,AA,DF,EZ,IM,MD,,AM,MM,ZT,MG,,XD
06/15-06/19,EZ,IM,DF,AM,MG,AA,MD,MM,XD,ZT,,
06/22-06/26,IM,EZ,MD,MG,DF,AM,AA,XD,MM,,,ZT`;

        const callScheduleCsvData = `Week,Call
6/30-7/4,XD
7/7- 7/11,MG
7/14-7/18,ZT
7/21-7/25,MM
7/28-8/1,DF
8/4-8/8,XD
8/11- 8/15,MM
8/18-8/22,IM
8/25-8/29,MG
9/1-9/5,DF
9/8-9/12,MM
9/15-9/19,IM
9/22-9/26,ZT
9/29-10/3,XD
10/6-10/10,MG
10/13-10/17,AM
10/20-10/24,XD
10/27-10/31,AA
11/3-11/7,MG
11/10-11/14,DF
11/17-11/21,MD
11/24-11/28,IM
12/1-12/5,EZ
12/8-12/12,MM
12/15-12/19,AM
12/22-12-26,AA
12/29-1/2/26,MD
01/05-01/09,EZ
01/12-01/16,AM
01/19-01/23,EZ
01/26-01/30,AA
02/02-02/06,MD
02/09-02/13,ZT
02/16-02/20,XD
02/23-02/27,MD
03/02-03/06,AA
03/09-03/13,ZT
03/16-03/20,MD
03/23-03/27,DF
03/30-04/03,EZ
04/06-04/10,AM
04/13-04/17,IM
04/20-04/24,EZ
04/27-05/01,AA
05/04-05/08,EZ
5/11-5/15,AM
05/18-05/22,IM
05/25-05/29,AA
06/01-06/05,MD
06/08-06/12,DF
06/15-06/19,AM
06/22-06/26,MG`;

        let ALL_FELLOWS = ["ZT", "MM", "XD", "DF", "MG", "IM", "AA", "EZ", "AM", "MD"]; 
        
        const ACTUAL_CURRENT_DATE = new Date(); 
        ACTUAL_CURRENT_DATE.setHours(0,0,0,0); 
        
        const CURRENT_SIMULATED_MONTH_DAY = { month: ACTUAL_CURRENT_DATE.getMonth() + 1, day: ACTUAL_CURRENT_DATE.getDate() };


        const fellowNames = {
            'ZT': 'Zahid Tarar', 
            'MM': 'Mahmoud Mansour', 
            'XD': 'Xheni Deda', 
            'DF': 'Darian Fard',
            'MG': 'Mustafa Gandhi', 
            'IM': 'Islam Mohamed', 
            'AA': 'Ahmed Ali', 
            'EZ': 'Eli Zaher', 
            'AM': 'Ambreen Merchant', 
            'MD': 'Mahmoud Mahdi'
        };


        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        const holidays = [
            // 2025
            { name: "New Year's Day", date: new Date(2025, 0, 1), indicator: "üéâ" },
            { name: "Ramadan", startDate: new Date(2025, 1, 28), endDate: new Date(2025, 2, 29), indicator: "üåôüïå" },
            { name: "Eid al-Fitr", date: new Date(2025, 2, 31), indicator: "ü•ôüéâ" },
            { name: "Easter", date: new Date(2025, 3, 20), indicator: "ü•ö" }, 
            { name: "Memorial Day", date: new Date(2025, 4, 26), indicator: "‚ö∞Ô∏èüïØ" },
            { name: "Eid al-Adha", date: new Date(2025, 5, 6), indicator: "üêë" },
            { name: "Juneteenth", date: new Date(2025, 5, 19), indicator: "‚úäüèø" },
            { name: "4th of July", date: new Date(2025, 6, 4), indicator: "üá∫üá∏" },
            { name: "Labor Day", date: new Date(2025, 8, 1), indicator: "üë∑‚Äç‚ôÇÔ∏è" },
            { name: "ACG Conference", startDate: new Date(2025, 9, 24), endDate: new Date(2025, 9, 29), indicator: "üßë‚Äçüíº", conferenceName: "ACG" }, 
            { name: "Thanksgiving", date: new Date(2025, 10, 27), indicator: "ü¶É" },
            { name: "Black Friday", date: new Date(2025, 10, 28), indicator: "üõçÔ∏èüí∏" },
            { name: "Christmas", date: new Date(2025, 11, 25), indicator: "üéÑüéÖ" }, 
            // 2026
            { name: "New Year's Day", date: new Date(2026, 0, 1), indicator: "üéâ" },
            { name: "Ramadan", startDate: new Date(2026, 1, 18), endDate: new Date(2026, 2, 19), indicator: "üåôüïå" },
            { name: "Eid al-Fitr", date: new Date(2026, 2, 20), indicator: "ü•ôüéâ" },
            { name: "Easter", date: new Date(2026, 3, 5), indicator: "ü•öüê∞" }, 
            { name: "DDW Conference", startDate: new Date(2026, 4, 2), endDate: new Date(2026, 4, 5), indicator: "üë©‚Äçüíº", conferenceName: "DDW" }, 
            { name: "Memorial Day", date: new Date(2026, 4, 25), indicator: "‚ö∞Ô∏èüïØ" },
            { name: "Eid al-Adha", date: new Date(2026, 4, 27), indicator: "üêë" },
            { name: "Juneteenth", date: new Date(2026, 5, 19), indicator: "‚úäüèø" },
            { name: "4th of July", date: new Date(2026, 6, 4), indicator: "üá∫üá∏" },
            { name: "Labor Day", date: new Date(2026, 8, 7), indicator: "üë∑‚Äç‚ôÇÔ∏è" },
            { name: "Thanksgiving", date: new Date(2026, 10, 26), indicator: "ü¶É" },
            { name: "Black Friday", date: new Date(2026, 10, 27), indicator: "üõçÔ∏èüí∏" },
            { name: "Christmas", date: new Date(2026, 11, 25), indicator: "üéÑüéÖ" } 
        ];
        holidays.forEach(h => { 
            if (h.date) h.date.setHours(0,0,0,0);
            if (h.startDate) h.startDate.setHours(0,0,0,0);
            if (h.endDate) h.endDate.setHours(23,59,59,999);
        });


        let parsedMainSchedule = []; 
        let mainScheduleHeaders = [];
        let callScheduleMap = {}; 
        let activeHighlights = new Set(); 
        let hidePreviousWeeks = true; 
        let currentZoomLevel; 
        let mdLastAssignmentWeekString = null; 

        const fellowSelect = document.getElementById('fellow-select');
        const scheduleDisplayContainer = document.getElementById('schedule-display');
        const noDataMessage = document.getElementById('no-data-message');
        const fellowButtonsContainer = document.getElementById('fellow-buttons-container');
        const hidePreviousWeeksToggle = document.getElementById('hide-previous-weeks-toggle'); 
        const zoomSlider = document.getElementById('zoom-slider'); 
        const zoomValueDisplay = document.getElementById('zoom-value');
        const exportIcsBtn = document.getElementById('export-ics-btn');
        const fellowButtonsDetails = document.getElementById('fellow-buttons-details');

        let BASE_FONT_SIZE_TD_REM;
        let BASE_PADDING_TD_Y_REM;
        let BASE_PADDING_TD_X_REM;
        let BASE_MIN_WIDTH_FIRST_COL_PX;
        let BASE_FONT_SIZE_HOLIDAY_CONTAINER_REM;
        let BASE_FONT_SIZE_CALL_ICON_EM;

        function setBaseSizingParameters() {
            const isMobile = window.innerWidth < 768;
            if (isMobile) {
                BASE_FONT_SIZE_TD_REM = 0.7; 
                BASE_PADDING_TD_Y_REM = 0.2;
                BASE_PADDING_TD_X_REM = 0.3;
                BASE_MIN_WIDTH_FIRST_COL_PX = 70; 
                BASE_FONT_SIZE_HOLIDAY_CONTAINER_REM = 0.55;
                BASE_FONT_SIZE_CALL_ICON_EM = 0.65;
            } else { 
                BASE_FONT_SIZE_TD_REM = 0.875; 
                BASE_PADDING_TD_Y_REM = 0.5;
                BASE_PADDING_TD_X_REM = 0.75;
                BASE_MIN_WIDTH_FIRST_COL_PX = 80; 
                BASE_FONT_SIZE_HOLIDAY_CONTAINER_REM = 0.6;
                BASE_FONT_SIZE_CALL_ICON_EM = 0.7;
            }
        }

        function applyZoomStyles(zoomFactor) {
            const table = scheduleDisplayContainer.querySelector('table');
            if (!table) return;

            const allTh = table.querySelectorAll('th');
            const allTd = table.querySelectorAll('td');
            
            allTh.forEach(el => {
                el.style.padding = `${BASE_PADDING_TD_Y_REM * zoomFactor * 0.9}rem ${BASE_PADDING_TD_X_REM * zoomFactor * 0.9}rem`;
                el.style.fontSize = `${BASE_FONT_SIZE_TD_REM * (0.95 + (zoomFactor - 0.95)*0.5) }rem`; 
            });

            allTd.forEach(el => {
                el.style.padding = `${BASE_PADDING_TD_Y_REM * zoomFactor}rem ${BASE_PADDING_TD_X_REM * zoomFactor}rem`;
                el.style.fontSize = `${BASE_FONT_SIZE_TD_REM * zoomFactor}rem`;
            });

            const firstColumnTds = table.querySelectorAll('tbody td:first-child');
            firstColumnTds.forEach(el => {
                el.style.minWidth = `${BASE_MIN_WIDTH_FIRST_COL_PX * zoomFactor}px`;
            });

            const holidayContainers = table.querySelectorAll('.holiday-indicators-container');
            holidayContainers.forEach(hc => {
                hc.style.fontSize = `${BASE_FONT_SIZE_HOLIDAY_CONTAINER_REM * zoomFactor}rem`;
            });
            
            const callIcons = table.querySelectorAll('.call-icon-inline');
            callIcons.forEach(ci => {
                ci.style.fontSize = `${BASE_FONT_SIZE_CALL_ICON_EM * zoomFactor}em`; 
            });
        }


        function parseMainScheduleCSV(data) {
            const lines = data.trim().split('\n');
            if (lines.length === 0) {
                mainScheduleHeaders = [];
                return [];
            }
            mainScheduleHeaders = lines[0].split(',').map(h => h.trim());
            let yearContext = 2025; 
            const schedule = lines.slice(1).map(line => {
                const values = line.split(',');
                const rowData = {};
                mainScheduleHeaders.forEach((header, index) => {
                     rowData[header] = (values[index] || '').trim();
                });
                
                const weekString = rowData['Week'];
                if (!weekString || weekString.trim() === "") return null; 

                const fullDateRange = getFullDateObjectsForWeek(weekString, yearContext);
                rowData.fullStartDate = fullDateRange.start;
                rowData.fullEndDate = fullDateRange.end;
                yearContext = fullDateRange.nextYearContext; 

                const nonDateValues = mainScheduleHeaders.slice(1).map(h => rowData[h]);
                if (nonDateValues.every(val => val.trim() === '')) return null; 
                return rowData;
            }).filter(row => row !== null);
            
            const discoveredFellows = new Set();
            const weekHeader = mainScheduleHeaders[0].toLowerCase();
            schedule.forEach(row => {
                for (const header of mainScheduleHeaders) {
                    if (header.toLowerCase() !== weekHeader && row[header]) {
                        const initials = row[header].trim();
                        if (initials && initials.length <= 3 && /^[A-Z]+$/.test(initials)) {
                            discoveredFellows.add(initials);
                        }
                    }
                }
            });
            ALL_FELLOWS = Array.from(discoveredFellows).sort();

            mdLastAssignmentWeekString = null;
            for (let i = schedule.length - 1; i >= 0; i--) {
                const weekData = schedule[i];
                for (const header of mainScheduleHeaders) {
                    if (header.toLowerCase() !== 'week' && header.toLowerCase() !== 'vacations' && weekData[header] === 'MD') {
                        mdLastAssignmentWeekString = weekData['Week'];
                        break; 
                    }
                }
                if (mdLastAssignmentWeekString) break;
            }

            return schedule;
        }

        function parseCallScheduleCSV(data) {
            const map = {};
            const lines = data.trim().split('\n');
            const startIndex = lines[0].toLowerCase().includes('week') ? 1 : 0; 
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const parts = line.split(',');
                if (parts.length === 2) {
                    const weekRange = parts[0].trim();
                    const fellow = parts[1].trim();
                    map[weekRange] = fellow;
                }
            }
            return map;
        }


        function populateFellowDropdown() {
            fellowSelect.innerHTML = '<option value="all">Show All Schedules</option>'; 
            ALL_FELLOWS.sort().forEach(fellow => {
                const option = document.createElement('option');
                option.value = fellow;
                option.textContent = fellowNames[fellow] ? `${fellow} (${fellowNames[fellow]})` : fellow;
                fellowSelect.appendChild(option);
            });
        }

        function getWeekMonthDayRange(weekString) {
            if (!weekString || !weekString.includes('-')) return null;
            const parts = weekString.split('-');
            if (parts.length !== 2) return null;
            const startDateParts = parts[0].split('/');
            const endDatePartsStr = parts[1].split('/');
            if (startDateParts.length < 2 || endDatePartsStr.length < 2) return null;
            const startMonth = parseInt(startDateParts[0], 10);
            const startDay = parseInt(startDateParts[1], 10);
            const endMonth = parseInt(endDatePartsStr[0], 10);
            const endDay = parseInt(endDatePartsStr[1], 10);
            if (isNaN(startMonth) || isNaN(startDay) || isNaN(endMonth) || isNaN(endDay)) return null;
            return { startMonth, startDay, endMonth, endDay };
        }

        function getFullDateObjectsForWeek(weekString, currentYearContext) {
            const [datePart1, datePart2] = weekString.split('-');
            const [startMonthStr, startDayStr] = datePart1.split('/');
            const startMonth = parseInt(startMonthStr, 10);
            const startDay = parseInt(startDayStr, 10);

            const endParts = datePart2.split('/');
            const endMonth = parseInt(endParts[0], 10);
            const endDay = parseInt(endParts[1], 10);
            const endYearShort = endParts.length === 3 ? parseInt(endParts[2], 10) : null;

            let sActualYear, eActualYear;
            let nextIterYearContext;

            if (endYearShort !== null) {
                eActualYear = 2000 + endYearShort;
                if (startMonth > endMonth) { 
                    sActualYear = eActualYear - 1;
                } else { 
                    sActualYear = eActualYear;
                }
                nextIterYearContext = eActualYear;
            } else { 
                sActualYear = currentYearContext;
                if (startMonth > endMonth) { 
                    eActualYear = currentYearContext + 1;
                } else {
                    eActualYear = currentYearContext;
                }
                nextIterYearContext = eActualYear;
            }
            const startDate = new Date(sActualYear, startMonth - 1, startDay);
            const endDate = new Date(eActualYear, endMonth - 1, endDay);
            startDate.setHours(0,0,0,0); 
            endDate.setHours(23,59,59,999);
            return { start: startDate, end: endDate, nextYearContext: nextIterYearContext };
        }


        function getHighlightClass(fellowInitial) { return `highlight-${fellowInitial.toLowerCase()}`; }

        function applyCellHighlights(tdElement, cellFellowInitial) {
            ALL_FELLOWS.forEach(f => tdElement.classList.remove(getHighlightClass(f)));
            tdElement.classList.remove('highlight-cell-base');
            if (activeHighlights.has(cellFellowInitial)) {
                tdElement.classList.add('highlight-cell-base');
                tdElement.classList.add(getHighlightClass(cellFellowInitial));
            }
        }
        
        function isDateInWeekRange(currentMonth, currentDay, weekRange) {
            if (!weekRange) return false;
            const { startMonth, startDay, endMonth, endDay } = weekRange;
            if (startMonth === endMonth) {
                return currentMonth === startMonth && currentDay >= startDay && currentDay <= endDay;
            } else {
                return (currentMonth === startMonth && currentDay >= startDay) || 
                       (currentMonth === endMonth && currentDay <= endDay);
            }
        }

        function attemptScrollToElement(element) {
            if (element) {
                setTimeout(() => {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }, 0);
            }
        }

        function getHolidayIndicatorsForWeek(weekString, weekFullStartDate, weekFullEndDate) {
            let indicatorsHtml = "";
            const processedHolidayKeysInThisCall = new Set(); 

            if (weekString === "12/22-12-26") {
                const christmasHoliday2025 = holidays.find(h => h.name === "Christmas" && h.date.getFullYear() === 2025);
                if (christmasHoliday2025) { 
                    indicatorsHtml += `<span class="holiday-indicator" title="${christmasHoliday2025.name}"><span class="emoji">${christmasHoliday2025.indicator}</span> <span class="date-text">${monthNames[christmasHoliday2025.date.getMonth()]} ${christmasHoliday2025.date.getDate()}</span></span>`;
                    processedHolidayKeysInThisCall.add(christmasHoliday2025.name + "_2025"); 
                }
            }

            holidays.forEach(holiday => {
                const holidayYear = holiday.date ? holiday.date.getFullYear() : holiday.startDate.getFullYear();
                const holidayKey = holiday.name + "_" + holidayYear;

                if (processedHolidayKeysInThisCall.has(holidayKey)) {
                    return; 
                }
                
                if (holiday.name === "Christmas" && holidayYear === 2025 && weekString === "12/22-12-26") {
                    return;
                }


                let holidayDateText = "";
                let displayHoliday = false;
                
                if (holiday.name === "Ramadan" || holiday.name === "ACG Conference" || holiday.name === "DDW Conference") {
                    if (holiday.startDate >= weekFullStartDate && holiday.startDate <= weekFullEndDate) {
                        displayHoliday = true;
                        if (holiday.name === "Ramadan") {
                            holidayDateText = `Starts ${monthNames[holiday.startDate.getMonth()]} ${holiday.startDate.getDate()}`;
                        } else { 
                            holidayDateText = `${holiday.conferenceName} ${monthNames[holiday.startDate.getMonth()]} ${holiday.startDate.getDate()} - ${monthNames[holiday.endDate.getMonth()]} ${holiday.endDate.getDate()}`;
                        }
                    }
                } else if (holiday.startDate && holiday.endDate) { 
                    if (holiday.startDate <= weekFullEndDate && holiday.endDate >= weekFullStartDate) {
                        displayHoliday = true;
                        holidayDateText = `${monthNames[holiday.startDate.getMonth()]} ${holiday.startDate.getDate()} - ${monthNames[holiday.endDate.getMonth()]} ${holiday.endDate.getDate()}`;
                        if (holiday.startDate.getTime() === holiday.endDate.getTime()) { 
                             holidayDateText = `${monthNames[holiday.startDate.getMonth()]} ${holiday.startDate.getDate()}`;
                        }
                    }
                } else { 
                    if (holiday.date >= weekFullStartDate && holiday.date <= weekFullEndDate) {
                        displayHoliday = true;
                        holidayDateText = `${monthNames[holiday.date.getMonth()]} ${holiday.date.getDate()}`;
                    }
                }

                if (displayHoliday) {
                    indicatorsHtml += `<span class="holiday-indicator" title="${holiday.name}"><span class="emoji">${holiday.indicator}</span> <span class="date-text">${holidayDateText}</span></span>`;
                    processedHolidayKeysInThisCall.add(holidayKey);
                }
            });
            return indicatorsHtml;
        }


        function renderFullSchedule(scheduleData, shouldScroll = true) { 
            scheduleDisplayContainer.innerHTML = '';
            noDataMessage.classList.add('hidden');
            fellowButtonsDetails.classList.remove('hidden'); 
            exportIcsBtn.classList.add('hidden'); 

            let dataToRender = scheduleData;
            let currentWeekRowElementForScroll = null; 

            if (hidePreviousWeeks) { 
                let firstFutureIndex = -1;
                for(let i=0; i < scheduleData.length; i++) {
                    if(scheduleData[i].fullEndDate >= ACTUAL_CURRENT_DATE) {
                        firstFutureIndex = i;
                        break;
                    }
                }
                if (firstFutureIndex !== -1) {
                    dataToRender = scheduleData.slice(firstFutureIndex);
                } else if (scheduleData.length > 0) { 
                    dataToRender = [scheduleData[scheduleData.length - 1]];
                } else {
                    dataToRender = []; 
                }
            }

            if (!dataToRender || dataToRender.length === 0 || mainScheduleHeaders.length === 0) {
                scheduleDisplayContainer.innerHTML = '<p class="text-center text-gray-500 p-4">No schedule data to display for the selected view.</p>';
                return;
            }

            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const headerRow = document.createElement('tr');
            mainScheduleHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            dataToRender.forEach((weekData, index) => { 
                const row = document.createElement('tr');
                const weekString = weekData['Week'];
                
                if (hidePreviousWeeks && index === 0) { 
                    row.classList.add('current-week-highlight');
                    currentWeekRowElementForScroll = row;
                } else if (!hidePreviousWeeks) { 
                    const monthDayRange = getWeekMonthDayRange(weekString); 
                    if (isDateInWeekRange(CURRENT_SIMULATED_MONTH_DAY.month, CURRENT_SIMULATED_MONTH_DAY.day, monthDayRange)) {
                        row.classList.add('current-week-highlight');
                        if (!currentWeekRowElementForScroll) { 
                           currentWeekRowElementForScroll = row;
                        }
                    }
                }


                const fellowOnCallThisWeek = callScheduleMap[weekString];
                const holidayIndicatorsHtml = getHolidayIndicatorsForWeek(weekString, weekData.fullStartDate, weekData.fullEndDate);


                mainScheduleHeaders.forEach((header, hIndex) => {
                    const td = document.createElement('td');
                    const cellContent = weekData[header] || '-';
                    let cellHtml = cellContent;

                    if (ALL_FELLOWS.includes(cellContent) && cellContent === fellowOnCallThisWeek) {
                        cellHtml += ` <span class="call-icon-inline">üìû</span>`;
                    }

                    if (cellContent === 'AA' && weekString === '11/24-11/28') {
                        cellHtml += ` <span class="asterisk-note">*</span>`;
                    }
                    if (cellContent === 'MD' && weekString === mdLastAssignmentWeekString) {
                         cellHtml += ` <span class="asterisk-note">**</span>`;
                    }
                    
                    if (hIndex === 0) { 
                        td.innerHTML = `<span class="week-cell-content">${cellContent}</span>`; 
                        if (holidayIndicatorsHtml) {
                            td.innerHTML += `<div class="holiday-indicators-container">${holidayIndicatorsHtml}</div>`;
                        }
                    } else {
                        td.innerHTML = cellHtml; 
                    }
                    
                    if (cellContent === '-') td.classList.add('no-assignment');
                    if (ALL_FELLOWS.includes(cellContent)) applyCellHighlights(td, cellContent);
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            scheduleDisplayContainer.appendChild(table);
            
            scheduleDisplayContainer.style.transform = `scale(${currentZoomLevel})`;
            scheduleDisplayContainer.style.width = `${100 / currentZoomLevel}%`;
            scheduleDisplayContainer.style.maxHeight = `${70 / currentZoomLevel}vh`;

            if (shouldScroll && currentWeekRowElementForScroll) { 
                attemptScrollToElement(currentWeekRowElementForScroll);
            } else if (shouldScroll && hidePreviousWeeks && dataToRender.length > 0) {
                const firstRowInTable = scheduleDisplayContainer.querySelector('tbody tr:first-child');
                if (firstRowInTable) attemptScrollToElement(firstRowInTable);
            }
        }
        
        let currentFellowAssignmentsForICS = []; 

        function renderFellowSchedule(fellowInitial, scheduleData, shouldScroll = true) { 
            scheduleDisplayContainer.innerHTML = '';
            noDataMessage.classList.add('hidden');
            fellowButtonsDetails.classList.add('hidden'); 
            exportIcsBtn.classList.remove('hidden'); 

            currentFellowAssignmentsForICS = []; 
            const allFellowAssignmentsThisFellow = [];
            
            parsedMainSchedule.forEach(weekData => { 
                 if (mainScheduleHeaders.length > 1) {
                    mainScheduleHeaders.slice(1).forEach(rotation => {
                        if (weekData[rotation] === fellowInitial) {
                            allFellowAssignmentsThisFellow.push({ 
                                week: weekData.Week, 
                                rotation: rotation,
                                fullStartDate: weekData.fullStartDate, 
                                fullEndDate: weekData.fullEndDate 
                            });
                        }
                    });
                }
            });
            currentFellowAssignmentsForICS = allFellowAssignmentsThisFellow; 

            let assignmentsToDisplay = allFellowAssignmentsThisFellow;
            if (hidePreviousWeeks) { 
                assignmentsToDisplay = allFellowAssignmentsThisFellow.filter(assignment => assignment.fullEndDate >= ACTUAL_CURRENT_DATE);
                 if (assignmentsToDisplay.length === 0 && allFellowAssignmentsThisFellow.length > 0) {
                    assignmentsToDisplay = [allFellowAssignmentsThisFellow[allFellowAssignmentsThisFellow.length - 1]];
                }
            }


            if (assignmentsToDisplay.length === 0) {
                noDataMessage.classList.remove('hidden');
                scheduleDisplayContainer.classList.add('hidden');
                exportIcsBtn.classList.add('hidden');
                return;
            }
            scheduleDisplayContainer.classList.remove('hidden');
            const table = document.createElement('table');
            table.style.minWidth = '100%'; 
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const individualHeaders = ['Week', 'Rotation/Activity']; 
            const headerRow = document.createElement('tr');
            individualHeaders.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                if (headerText === 'Week') { 
                    th.style.position = 'sticky'; th.style.left = '0';
                    th.style.zIndex = '12'; th.style.backgroundColor = '#607d8b';
                }
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            let currentWeekRowElementForHighlight = null;

            assignmentsToDisplay.forEach((assignment, index) => { 
                const row = document.createElement('tr');
                const weekString = assignment.week;
                
                if (hidePreviousWeeks && index === 0) { 
                    row.classList.add('current-week-highlight');
                    currentWeekRowElementForHighlight = row;
                } else if (!hidePreviousWeeks) { 
                    const monthDayRange = getWeekMonthDayRange(weekString);
                    if (isDateInWeekRange(CURRENT_SIMULATED_MONTH_DAY.month, CURRENT_SIMULATED_MONTH_DAY.day, monthDayRange)) {
                        row.classList.add('current-week-highlight');
                        if (!currentWeekRowElementForHighlight) {
                           currentWeekRowElementForHighlight = row;
                        }
                    }
                }
                
                const weekCell = document.createElement('td');
                weekCell.innerHTML = `<span class="week-cell-content">${weekString}</span>`;
                const holidayIndicatorsHtml = getHolidayIndicatorsForWeek(weekString, assignment.fullStartDate, assignment.fullEndDate);
                if (holidayIndicatorsHtml) {
                    weekCell.innerHTML += `<div class="holiday-indicators-container">${holidayIndicatorsHtml}</div>`;
                }

                weekCell.style.position = 'sticky'; weekCell.style.left = '0'; weekCell.style.zIndex = '5';
                row.appendChild(weekCell);

                let rotationCellContent = assignment.rotation;
                const fellowOnCallThisWeek = callScheduleMap[weekString];
                if (fellowInitial === fellowOnCallThisWeek) {
                    rotationCellContent += ` <span class="call-icon-inline">üìû</span>`;
                }
                if (fellowInitial === 'AA' && weekString === '11/24-11/28') {
                    rotationCellContent += ` <span class="asterisk-note">*</span>`;
                }
                if (fellowInitial === 'MD' && weekString === mdLastAssignmentWeekString) {
                     rotationCellContent += ` <span class="asterisk-note">**</span>`;
                }

                const rotationCell = document.createElement('td');
                rotationCell.innerHTML = rotationCellContent;
                row.appendChild(rotationCell);
                tbody.appendChild(row);
            });
            table.appendChild(tbody);
            scheduleDisplayContainer.appendChild(table);
            
            scheduleDisplayContainer.style.transform = `scale(${currentZoomLevel})`;
            scheduleDisplayContainer.style.width = `${100 / currentZoomLevel}%`;
            scheduleDisplayContainer.style.maxHeight = `${70 / currentZoomLevel}vh`;

            if (shouldScroll && currentWeekRowElementForHighlight) {
                 attemptScrollToElement(currentWeekRowElementForHighlight);
            } else if (shouldScroll && hidePreviousWeeks && assignmentsToDisplay.length > 0) {
                 const firstRowInTable = scheduleDisplayContainer.querySelector('tbody tr:first-child');
                if (firstRowInTable) attemptScrollToElement(firstRowInTable);
            }
        }

        function generateICSContent(fellowInitial, assignments) {
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                `PRODID:-//FellowScheduleApp//${fellowNames[fellowInitial] || fellowInitial}//EN`,
            ];

            const formatDateForICS = (date) => {
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const day = date.getDate().toString().padStart(2, '0');
                return `${year}${month}${day}`;
            };

            assignments.forEach((assignment, index) => {
                const uid = `fellowschedule-${fellowInitial}-${assignment.fullStartDate.getTime()}-${index}@example.com`; 
                const dtstamp = new Date().toISOString().replace(/[-:.]/g, '').slice(0, 15) + 'Z';
                
                const summary = `${assignment.rotation} (${fellowNames[fellowInitial] || fellowInitial})`;
                
                const dtEnd = new Date(assignment.fullEndDate);
                dtEnd.setDate(dtEnd.getDate() + 1); 

                icsContent.push('BEGIN:VEVENT');
                icsContent.push(`UID:${uid}`);
                icsContent.push(`DTSTAMP:${dtstamp}`);
                icsContent.push(`DTSTART;VALUE=DATE:${formatDateForICS(assignment.fullStartDate)}`);
                icsContent.push(`DTEND;VALUE=DATE:${formatDateForICS(dtEnd)}`);
                icsContent.push(`SUMMARY:${summary}`);
                icsContent.push('END:VEVENT');
            });

            icsContent.push('END:VCALENDAR');
            return icsContent.join('\r\n');
        }

        function downloadICSFile(filename, content) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) { 
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        exportIcsBtn.addEventListener('click', () => {
            const selectedFellowInitial = fellowSelect.value;
            if (selectedFellowInitial && selectedFellowInitial !== 'all' && currentFellowAssignmentsForICS.length > 0) {
                const fellowFullName = fellowNames[selectedFellowInitial] || selectedFellowInitial;
                const icsData = generateICSContent(selectedFellowInitial, currentFellowAssignmentsForICS); 
                downloadICSFile(`${fellowFullName}_schedule.ics`, icsData);
            } else {
                const scheduleDisplayDiv = document.getElementById('schedule-display');
                let messageDiv = document.getElementById('temp-message-div');
                if (!messageDiv) {
                    messageDiv = document.createElement('div');
                    messageDiv.id = 'temp-message-div';
                    messageDiv.style.padding = '10px';
                    messageDiv.style.backgroundColor = '#ffdddd';
                    messageDiv.style.border = '1px solid #ffaaaa';
                    messageDiv.style.color = '#D8000C';
                    messageDiv.style.textAlign = 'center';
                    messageDiv.style.borderRadius = '5px';
                    messageDiv.style.marginBottom = '10px';
                }
                messageDiv.textContent = 'Please select a fellow with a displayed schedule to export.';
                
                if (scheduleDisplayDiv.firstChild) {
                    scheduleDisplayDiv.insertBefore(messageDiv, scheduleDisplayDiv.firstChild);
                } else {
                    scheduleDisplayDiv.appendChild(messageDiv);
                }
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000); 
            }
        });


        function toggleFellowHighlight(fellowInitial, buttonElement) {
            if (activeHighlights.has(fellowInitial)) activeHighlights.delete(fellowInitial);
            else activeHighlights.add(fellowInitial);
            buttonElement.classList.toggle('active');
            if (fellowSelect.value === 'all') renderFullSchedule(parsedMainSchedule, false); 
        }

        function clearAllHighlights() {
            activeHighlights.clear();
            document.querySelectorAll('.fellow-btn.active').forEach(btn => btn.classList.remove('active'));
            if (fellowSelect.value === 'all') renderFullSchedule(parsedMainSchedule, false); 
        }

        function populateFellowButtons() {
            fellowButtonsContainer.innerHTML = ''; 
            ALL_FELLOWS.forEach(fellow => {
                const button = document.createElement('button');
                button.classList.add('fellow-btn');
                button.textContent = fellow;
                button.title = fellowNames[fellow] || fellow; 
                button.dataset.fellow = fellow; 
                if (activeHighlights.has(fellow)) button.classList.add('active');
                button.addEventListener('click', () => toggleFellowHighlight(fellow, button));
                fellowButtonsContainer.appendChild(button);
            });
            const clearButton = document.createElement('button');
            clearButton.classList.add('clear-highlights-btn');
            clearButton.textContent = 'Clear Highlights';
            clearButton.addEventListener('click', clearAllHighlights);
            fellowButtonsContainer.appendChild(clearButton);
        }
        
        hidePreviousWeeksToggle.addEventListener('change', (event) => { 
            hidePreviousWeeks = event.target.checked; 
            const selectedFellow = fellowSelect.value;
            const shouldScroll = hidePreviousWeeks; 

            if (selectedFellow === 'all') {
                renderFullSchedule(parsedMainSchedule, shouldScroll);
            } else {
                renderFellowSchedule(selectedFellow, parsedMainSchedule, shouldScroll);
            }
        });
        
        zoomSlider.addEventListener('input', (event) => { 
            currentZoomLevel = parseFloat(event.target.value);
            scheduleDisplayContainer.style.transform = `scale(${currentZoomLevel})`;
            scheduleDisplayContainer.style.width = `${100 / currentZoomLevel}%`;
            scheduleDisplayContainer.style.maxHeight = `${70 / currentZoomLevel}vh`; 

            zoomValueDisplay.textContent = `${Math.round(currentZoomLevel * 100)}%`;
        });


        fellowSelect.addEventListener('change', (event) => {
            const selectedFellow = event.target.value;
            if (selectedFellow === 'all') {
                exportIcsBtn.classList.add('hidden');
                fellowButtonsDetails.classList.remove('hidden'); 
                if (fellowButtonsDetails) fellowButtonsDetails.open = !(window.innerWidth < 768);

                scheduleDisplayContainer.classList.remove('hidden');
                renderFullSchedule(parsedMainSchedule, hidePreviousWeeks); 
            } else {
                fellowButtonsDetails.classList.add('hidden');
                renderFellowSchedule(selectedFellow, parsedMainSchedule, hidePreviousWeeks);
            }
        });

        function initializeApp() {
            if (window.innerWidth < 768) { 
                currentZoomLevel = 0.5; 
            } else {
                currentZoomLevel = 1.0; 
            }

            hidePreviousWeeksToggle.checked = hidePreviousWeeks; 
            zoomSlider.min = "0.3"; 
            zoomSlider.max = "1.0";
            zoomSlider.value = currentZoomLevel; 
            zoomValueDisplay.textContent = `${Math.round(currentZoomLevel * 100)}%`;
            
            scheduleDisplayContainer.style.transform = `scale(${currentZoomLevel})`;
            scheduleDisplayContainer.style.width = `${100 / currentZoomLevel}%`;
            scheduleDisplayContainer.style.maxHeight = `${70 / currentZoomLevel}vh`;

            setBaseSizingParameters(); 
            parsedMainSchedule = parseMainScheduleCSV(mainScheduleCsvData); 
            callScheduleMap = parseCallScheduleCSV(callScheduleCsvData); 
            populateFellowDropdown(); 
            populateFellowButtons();  
            renderFullSchedule(parsedMainSchedule, hidePreviousWeeks); 

            if (fellowButtonsDetails) {
                 fellowButtonsDetails.open = !(window.innerWidth < 768 && fellowSelect.value === 'all');
                 if(fellowSelect.value !== 'all') fellowButtonsDetails.classList.add('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
